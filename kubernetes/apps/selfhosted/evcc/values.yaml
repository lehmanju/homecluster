---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/refs/heads/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json

controllers:
  evcc:
    containers:
      main:
        image:
          repository: docker.io/evcc/evcc
          tag: nightly@sha256:e1cb2a85ce656b385079c0822bfc7eab7f6b0d2489b778ad9b071be227888c20
        args: ["-c", "/config/evcc.yaml", "--disable-auth"]
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: 10m

configMaps:
  evcc-config:
    data:
      evcc.yaml: |
        database:
          type: sqlite
          dsn: /data/evcc.db

defaultPodOptions:
  annotations:
    k8s.v1.cni.cncf.io/networks: |
      [{
        "name": "multus-iot",
        "interface": "eth1",
        "namespace": "multus",
        "ips": ["192.168.1.46/24"]
      }]
  securityContext:
    runAsNonRoot: true
    runAsUser: 568
    runAsGroup: 568
    fsGroup: 568
    fsGroupChangePolicy: OnRootMismatch

service:
  app:
    controller: evcc
    ports:
      http:
        port: &port 7070

persistence:
  data:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 10Gi
    retain: true
    globalMounts:
      - path: /data
  config:
    type: configMap
    identifier: evcc-config
    globalMounts:
      - path: /config

route:
  app:
    hostnames:
      - evcc.devpi.de
    parentRefs:
      - name: web-internal
        namespace: cilium
        sectionName: https
    rules:
      - backendRefs:
          - name: evcc
            port: *port
        matches:
          - path:
              type: PathPrefix
              value: /
